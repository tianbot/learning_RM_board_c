
# Class 1 ç¯å¢ƒæ­å»º

[ã€åµŒå…¥å¼å°ç™½çš„å­¦ä¹ ä¹‹è·¯ã€‘1.UbuntuåµŒå…¥å¼å¼€å‘-ç¯å¢ƒæ­å»º](https://www.bilibili.com/video/BV1UV411M7WF)

[ã€åµŒå…¥å¼å°ç™½çš„å­¦ä¹ ä¹‹è·¯ã€‘ç•ªå¤–ç¯‡ï¼šWindowsä¸‹çš„ç¯å¢ƒæ­å»º](https://www.bilibili.com/video/BV1qh4y187WV/)

è§†é¢‘æ¼”ç¤ºçš„ç¯å¢ƒæ­å»ºåŸºäº Ubuntu 20.04 LTS ã€‚

ä¼—æ‰€å‘¨çŸ¥ï¼Œç¯å¢ƒæ­å»ºæ°¸è¿œæ˜¯å„ä¸ªä¸ç”µè„‘ç›¸å…³çš„å¼€å‘ä¸­æœ€å›°éš¾çš„ä¸€æ­¥ï¼Œæœ¬æ–‡æ¡£å°†ä¼šä½¿ç”¨ä¿å§†çº§çš„æ­¥éª¤æ•™ä½ åœ¨Ubuntu 20.04 ä¸­é…ç½®åµŒå…¥å¼å¼€å‘ç¯å¢ƒã€‚

ç¯å¢ƒæ­å»ºæ¨èå¤§å®¶æ—¥å¸¸ä½¿ç”¨æ¯”è¾ƒæ–¹ä¾¿çš„è®¾å¤‡ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬åœ¨æœºå™¨äººå¼€å‘ä¸­å¸¸ç”¨çš„ Ubuntu ç³»ç»Ÿçš„ ROS2GO è®¾å¤‡æˆ–è€… mini PCè®¾å¤‡ã€‚å¦‚æœå¸¸ç”¨çš„å¼€å‘è®¾å¤‡æ˜¯ Windows ç³»ç»Ÿçš„è¯ï¼Œæˆ‘æ¨èå¤§å®¶æŒ‰ç…§æ–‡æ¡£ç»“å°¾è¡¥å……çš„ Windows ç³»ç»Ÿä¸‹ GCC + OpenOCD + VSCode çš„ç¯å¢ƒè¿›è¡Œæ­å»ºã€‚

ä¸æ¨èå¤§å®¶åœ¨è™šæ‹Ÿæœºé‡Œæ­å»ºå¼€å‘ç¯å¢ƒ(â—'â—¡'â—)

## ç¬¬ä¸€æ­¥ã€å®‰è£…GCC

https://developer.arm.com/downloads/-/gnu-rm

1. è§£å‹GCC
```bash
tar -xvjf gcc-arm-none-eabi-10.3-2021.10-x86_64-linux.tar
```


2. é…ç½®ç¯å¢ƒå˜é‡
```bash
sudo gedit /etc/profile
```

3. æ–‡æ¡£æœ«å°¾è¾“å…¥
```bash
export PATH=$PATH:/home/tianbot/arm_stm32_study/arm/bin        
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/home/tianbot/arm_stm32_study/arm/lib  
```
  

4. åº”ç”¨ç¯å¢ƒå˜é‡
```bash
source /etc/profile
```

5. æŸ¥çœ‹æ˜¯å¦å®‰è£…æˆåŠŸ
```bash
arm-none-eabi-gcc -v
```
å¯èƒ½ä¼šå‡ºç°é—®é¢˜ï¼Œè§ä¸‹`å¯èƒ½å‡ºç°çš„é—®é¢˜`éƒ¨åˆ†çš„`é—®é¢˜1`ã€‚


## ç¬¬äºŒæ­¥ã€å®‰è£…openocd
1. ä¸‹è½½xpgkåŒ…

https://xpack.github.io/dev-tools/openocd/install/#linux_1

2. æå–åéšä¾¿æ”¾åœ¨å“ªä¸ªè·¯å¾„éƒ½è¡Œï¼Œä½†æ˜¯è¦è®°å¾—æ”¾åœ¨å“ªäº†
```bash
(openocdè·¯å¾„)/openocd -v
```

3. æ’å…¥dap-linkï¼Œçœ‹æ˜¯å¦èƒ½æŸ¥è¯¢åˆ°è®¾å¤‡
```bash
(openocdè·¯å¾„)/openocd -f interface/cmsis-dap.cfg 
```

## ç¬¬ä¸‰æ­¥ã€å®‰è£…STM32CubeMX 

1. åœ¨STå®˜ç½‘ä¸‹è½½ 
2. ç”Ÿæˆå·¥ç¨‹ 
3. Toolchain/IDEè®¾ç½®ä¸ºmakefile 

## ç¬¬å››æ­¥ã€é…ç½®VScode å¹¶ç¼–è¯‘åŠè¿è¡Œå·¥ç¨‹

1. æ‰“å¼€ç”Ÿæˆçš„å·¥ç¨‹
2. å®‰è£…æ‰©å±•Cortex Debug
3. ç‚¹å‡»å°é½¿è½®ï¼Œé…ç½®Cortex Debugè®¾ç½®
`setting.json`:
å®‰è£…gccçš„ç›®å½•ä½ç½®<br>
```json
"cortex-debug.gdbPath": "/home/tianbot/arm_stm32_study/arm/bin/arm-none-eabi-gdb",
```
å®‰è£…openocdçš„ç›®å½•ä½ç½®<br>
```json
"cortex-debug.openocdPath.linux": "/usr/bin/openocd"
```
è®¾ç½®`launch.json`æ–‡ä»¶<br>
```json
"configFiles":[
    "interface/cmsis-dap.cfg",        
    "target/stm32f4x.cfg"
]
```
openocdæ–‡ä»¶å¤¹ä¸‹è‡ªå¸¦çš„ä»¿çœŸå™¨æ–‡ä»¶ä»¥åŠå¤„ç†å™¨çš„ä»¿çœŸæ–‡ä»¶
4. è¿æ¥è°ƒè¯•å™¨ä¸mcuï¼Œæµ‹è¯•å‘½ä»¤
```bash
openocd -f interface/cmsis-dap.cfg -f target/stm32f4x.cfg
```


é…ç½®å¥½çš„`launch.json`å¦‚ä¸‹ï¼š
```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "showDevDebugOutput": "parsed",
            "name": "Cortex Debug STM32F4X",
            "cwd": "${workspaceFolder}",
            "executable": "./build/${workspaceFolderBasename}.elf",
            "request": "launch",
            "type": "cortex-debug",
            "device": "stm32f407",
            "servertype": "openocd",

            "configFiles": [
                "interface/cmsis-dap.cfg",        
                "target/stm32f4x.cfg"
            ]   
        }
    ]
}
```


##  <span id="step5">ç¬¬äº”æ­¥ã€ï¼ˆå¯é€‰ï¼‰åº”ç”¨é”™è¯¯æ³¢å½¢æ›²çº¿</span>


å·æ‡’çš„äººå¯ä»¥ç›´æ¥å…³é—­é”™è¯¯æ³¢å½¢æ›²çº¿ï¼Œä½†æ˜¯æ‹¥æœ‰é”™è¯¯æ³¢å½¢æ›²çº¿ä¼šä½¿å¾—æˆ‘ä»¬çš„è°ƒè¯•æ›´åŠ é¡ºåˆ©

1. `ctrl+shift+p`æœé”™è¯¯æ³¢å½¢æ›²çº¿ï¼Œæ‰“å¼€

2. é¼ æ ‡æ”¾ç½®åœ¨é€‰ä¸­çš„é”™è¯¯æ³¢å½¢ä¸Šï¼Œé€‰æ‹©`Quick Fix - Edit IncludePath` è¿›å…¥UIç•Œé¢ï¼Œç‚¹å‡»Switch to the `c_cpp_properties.json` file è¶…é“¾æ¥è¿›å…¥.jsonæ–‡ä»¶

3. ç¼–è¾‘c_cpp_properties.json
ç¼–è¾‘definesä¸º
```json
"defines": [
                "USE_HAL_DRIVER",
                "STM32F407xx"
            ],
```
"compilerPath"æ”¹ä¸ºarm-none-eabi-gccçš„è·¯å¾„


`c_cpp_properties.json`ç¤ºä¾‹å¦‚ä¸‹
```json
{
    "configurations": [
        {
            "name": "STM32",
            "includePath": [
                "${workspaceFolder}/**"
              ],
            "defines": [
                "USE_HAL_DRIVER",
                "STM32F407xx"
            ],
            "cStandard": "c99",
            "cppStandard": "c++14",
            "intelliSenseMode": "linux-clang-x64",
            "compilerPath": "/home/tianbot/arm_stm32_study/arm/bin/arm-none-eabi-gcc"
        }
    ],
    "version": 4
}
```

## å¯èƒ½å‡ºç°çš„é—®é¢˜

### é—®é¢˜1

åº”ç”¨ç¯å¢ƒå˜é‡ä¹‹åï¼ŒæŠ¥é”™ç¼ºå°‘å¯¹åº”çš„libraries

```bash
tianbot@ros2go:~/Desktop/LED_TEST$ arm-none-eabi-gdb -v
arm-none-eabi-gdb: error while loading shared libraries: libncurses.so.5: cannot open shared object file: No such file or directory
```


è§£å†³æ–¹æ¡ˆï¼šç¼ºä»€ä¹ˆä¸‹ä»€ä¹ˆï¼Œè¿™é‡Œä¸‹è½½ `libncurses5` ä¾èµ–

```bash
sudo apt-get install libncurses5
```

### é—®é¢˜2

**Permission Deny**

>Experiments with a different CMSIS-DAP show that this is probably a permission issue  - openocd does not distinguish between the absence of a CMISIS-DAP  programmer vs. lack of permission to access one which is present. The  usual solution is to create or install an appropriate udev rule and then  restart udev or the system and replug the device.


åŸºæœ¬ä¸Šåªå‡ºç°åœ¨ linux ä¸Šï¼Œ windows æ˜¯ä¸ä¼šæœ‰è¿™ä¸ªçš„

è¿™ä¸ªæ˜¯æƒé™é—®é¢˜ã€‚ä¹Ÿå°±æ˜¯ openocd æ²¡æœ‰æƒé™çœ‹åˆ°ã€æ“ä½œè°ƒè¯•å™¨ã€‚

è§£å†³æ–¹æ³•ï¼š

æ‰“å¼€ç›®å½• `openocd/contrib` ï¼Œå°† `dd-openocd.rules` æ‹·è´åˆ° `/etc/udev/rules.d/` ä¸‹ã€‚

```bash
sudo cp ./60-openocd.rules  /etc/udev/rules.d
```

è§£é‡Šä¸€ä¸‹ï¼Œè¯¥ *.rules æ–‡ä»¶æ˜¯ä¸€ç³»åˆ—è®¾å¤‡æè¿°å’Œæƒé™é…ç½®çš„æ–‡ä»¶ã€‚å®˜æ–¹å·²ç»ç»™é…å¥½è°ƒè¯•å™¨çš„æƒé™ã€‚åªéœ€è¦æŠŠè¿™ä¸ªæ–‡ä»¶æ”¾è¿› udev çš„ rules.d ç›®å½•ä¸‹ï¼Œä»¤å…¶ç”Ÿæ•ˆå³å¯ã€‚æœ‰äº›æ—¶å€™ï¼Œéœ€è¦æŠŠè°ƒè¯•å™¨é‡æ–°æ’ä¸Šå»ï¼ŒæŒ‰ç…§æ–°è§„åˆ™è¿›è¡ŒæŒ‚è½½ã€‚

Ubuntuç¯å¢ƒæ­å»ºå‚è€ƒèµ„æ–™ï¼š
https://www.bilibili.com/video/BV12R4y1Q7ic

# Windowsä¸‹é…ç½®ç¯å¢ƒ

ç®€å•å››æ­¥ï¼Œé…ç½® Windows ä¸‹ GCC + OpenOCD + VSCode å¼€å‘ç¯å¢ƒ

1. [VSCode](https://code.visualstudio.com/) ä¸ [CubeMX](https://www.st.com/en/development-tools/stm32cubemx.html) çš„ä¸‹è½½å®‰è£…ï¼Œç›´æ¥ä¸€è·¯ä¸‹ä¸€æ­¥

2. [Openocd xPackä¸‹è½½](https://github.com/xpack-dev-tools/openocd-xpack/releases)
    
    ä¸‹è½½ xpack-openocd-0.12.0-1-**win32-x64.zip** ï¼Œéšä¾¿è§£å‹åˆ°ä½ è®¤è¯†çš„åœ°æ–¹ï¼Œæ¥ä¸‹æ¥çš„æ­¥éª¤ä¸Ubuntuä¸‹ç›¸åŒ


3. [GNU Arm Embedded Toolchain Downloads](https://developer.arm.com/downloads/-/gnu-rm)

    ä¸‹è½½å®‰è£… gcc-arm-none-eabi-10.3-2021.10-**win32.exe** ï¼Œä¸€è·¯ä¸‹ä¸€æ­¥ï¼Œæœ€åå‹¾é€‰ `Add path to environment variable`

4. VSCode æ‰©å±•ä¸­ä¸‹è½½ cortex-debug ï¼Œåœ¨ `setting.json` ä¸­é…ç½® openocd ã€arm-none-eabi-gdb è·¯å¾„ï¼Œé…ç½® `launch.json` ï¼ˆè¿‡ç¨‹å’Œä¸Šè¿° Linux çš„ç±»ä¼¼

    - cortex-debugé…ç½®
        
        ç‚¹å‡»å°é½¿è½®ï¼Œè¿›å…¥ `setting.json`
        
        åœ¨æœ€åæ·»åŠ ä¸‹é¢ GCC å’Œ OpenOCD è·¯å¾„ï¼Œ ***è®°å¾—æŠŠè·¯å¾„æ”¹ä¸ºè‡ªå·±çš„æ–‡ä»¶è·¯å¾„*** 
        ```json
            "cortex-debug.gdbPath": "C:\\Program Files (x86)\\GNU Arm Embedded Toolchain\\10 2021.10\\bin\\arm-none-eabi-gdb.exe",
            "cortex-debug.openocdPath.windows": "D:\\Env\\xpack-openocd-0.12.0-1\\bin\\openocd"
        ```

    - `launch.json` é…ç½®ï¼ˆå®Œå…¨ä¸ä¸Šè¿°Ubuntuçš„ä¸€æ¨¡ä¸€æ ·ï¼‰
    ```json
    {
        "version": "0.2.0",
        "configurations": [
            {
                "name": "Cortex Debug",
                "cwd": "${workspaceFolder}",
                "executable": "./build/${workspaceFolderBasename}.elf",
                "request": "launch",
                "type": "cortex-debug",
                "device": "stm32f407",
                "servertype": "openocd",

                "configFiles": [
                    "interface/cmsis-dap.cfg",        
                    "target/stm32f4x.cfg"
                ]  
            }
        ]
    }
    ```

5. Windows ä¸‹ä¸ç”¨ç‰¹åœ°é…ç½®é”™è¯¯æ³¢å½¢æ›²çº¿ ğŸ˜Š ä½†å¦‚æœå‡ºç°æ²¡æœ‰é”™è¯¯æ³¢å½¢æ›²çº¿çš„é—®é¢˜ï¼Œå¯ä»¥å‚è€ƒç¬¬äº”æ­¥çš„é…ç½®ï¼š[åº”ç”¨é”™è¯¯æ³¢å½¢æ›²çº¿](#ç¬¬äº”æ­¥å¯é€‰åº”ç”¨é”™è¯¯æ³¢å½¢æ›²çº¿)

å¤§å®¶æœ‰ä»»ä½•é—®é¢˜æ¬¢è¿æå‡ºï¼